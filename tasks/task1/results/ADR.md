# Архитектурное решение (ADR): Миграция монолита Hotelio на микросервисную архитектуру

### Название задачи:
Проработка миграции от монолита к микросервисам (Задание 1)

### Автор:
Александр Сосорев 

### Дата:
2026-02-24

### Функциональные требования

| **№** | **Действующие лица или системы** | **Use Case**           | **Описание**                                                                                                                |
|:-----:|:---------------------------------|:-----------------------|:----------------------------------------------------------------------------------------------------------------------------|
|   1   | Пользователь                     | Создание бронирования  | Создание брони. Система проверяет пользователя, наличие мест в отеле, рейтинг отеля и промокод, после чего сохраняет бронь. |
|   2   | Пользователь / Фронтенд          | Просмотр отелей        | Получение списка отелей, их рейтинга и доступности.                                                                         |
|   3   | Система (BookingService)         | Проверка пользователя  | Проверка активности пользователя и его статуса (VIP) перед бронированием.                                                   |
|   4   | Система (BookingService)         | Проверка промокода     | Проверка валидности промокода с учетом статуса пользователя.                                                                |
|   5   | Система (BookingService)         | Прогрев кеша и отзывов | Проверка надежности отеля на основе его отзывов.                                                                            |

### Нефункциональные требования

| **№** | **Требование**                                                                                                                                             |
|:-----:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------|
|   1   | **Масштабируемость**: Отдельные сильно нагруженные узлы (в первую очередь бронирование) должны масштабироваться независимо от остальной системы.           |
|   2   | **Отказоустойчивость**: Падение или медленная работа некритичных сервисов (например, отзывы) не должна приводить к полной деградации сервиса бронирования. |
|   3   | **Изолированность разработки**: Команды должны иметь возможность проводить независимые циклы CI/CD для разных частей системы.                              |
|   4   | **Производительность**: Миграция должна быть поэтапной и не приводить к критическому росту latency на этапе разделения (до внедрения кэширования).         |

### Решение
Для системного решения проблем предложен поэтапный переход на микросервисную архитектуру с использованием паттерна **Strangler Fig**. Это позволит плавно снижать связанность без остановки разработки новых фичей.

**Целевое состояние**: 
Множество независимых микросервисов, каждый из которых работает с собственной базой данных. Взаимодействие переведено на асинхронные события (Kafka) для консистентности и синхронные вызовы (REST/gRPC) для чтения. На фронтенде предусмотрен паттерн BFF/GraphQL.

**Первый шаг миграции — вынесение модуля `ReviewService` в отдельный микросервис.**

**Обоснование выбора (ReviewService):**
1. **Нулевая исходящая связность**: Этот сервис не зависит от других сервисов внутри текущего монолита. Он только предоставляет информацию монолиту. Выделить его проще всего, так как не потребуется проксировать его внутренние запросы.
2. **Низкий риск**: Отзывы — важная, но не транзакционно-критичная по отношению к деньгам пользователей часть (в отличие от Booking и Promo).
3. **Ограниченность ресурсов**: Идеальный кандидат на первую проверку гипотезы (Proof of Concept) миграционной инфраструктуры (CICD, логи, трейсы), так как сервис минималистичен.

**План миграции (Strangler Fig):**
1. Развернуть отдельную БД (или логическую схему) для нового сервиса `review-service` и настроить репликацию/миграцию таблицы `review`.
2. Создать новый Spring Boot микросервис `review-service`, скопировав в него логику работы с отзывами из монолита. Запустить микросервис в Production-среде.
3. В коде монолита заменить прямые вызовы класса `ReviewService` на вызовы HTTP/REST-клиента `ReviewServiceClient`, который будет обращаться по сети к новому сервису.
4. Настроить API Gateway (или Ingress) для прямой маршрутизации запросов от фронтенда вида `/api/reviews/*` на новый сервис «в обход» монолита (Strangler Fig pattern).
5. Как только трафик начнет успешно обслуживаться новым сервисом, удалить таблицу `review` и код старого `ReviewService` (включая контроллеры) из кодовой базы монолита.

### Альтернативы
- **Вынесение `AppUserService`:** Этот сервис завязан на большое количество других процессов (Booking, PromoCode). Его вынесение в первую очередь потребовало бы изменения нескольких сервисов внутри монолита сразу и значительно усложнило бы старт, повысив риски на первом этапе миграции.

**Недостатки, ограничения, риски**
- **Появление сетевых задержек (Latency):** При проверке надежности отеля монолит теперь совершает сетевой запрос вместо вызова метода в памяти. Это нужно будет нивелировать таймаутами и, возможно, Circuit Breaker.
- **Риск распределенных транзакций/каскадных сбоев:** Потребуется правильно настроить инфраструктуру отказоустойчивости (повторы, таймауты).
- **Сложность мониторинга:** Необходимо с первого дня внедрять сквозной трейсинг (distributed tracing) на базе предложенной инфраструктуры, чтобы отслеживать запросы между монолитом и `review-service`.
