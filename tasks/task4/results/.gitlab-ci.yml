stages:
  - build
  - test
  - deploy
  - tag

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: booking-service

build:
  stage: build
  script:
    - cd booking-service
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .

test:
  stage: test
  script:
    - docker run -d --name test-$IMAGE_NAME -p 8080:8080 $IMAGE_NAME:$IMAGE_TAG
    - sleep 5
    - curl -f http://localhost:8080/ping
    - docker rm -f test-$IMAGE_NAME

deploy:
  stage: deploy
  script:
    - minikube image load $IMAGE_NAME:$IMAGE_TAG
    - helm upgrade --install $IMAGE_NAME ./helm/$IMAGE_NAME -f values-staging.yaml

tag:
  stage: tag
  script:
    - apk add git || apt-get install -y git || yum install -y git || true
    - TIMESTAMP=$(date +%Y%m%d%H%M%S)
    - git tag -a "deploy-$TIMESTAMP" -m "Deployed at $TIMESTAMP" || echo "Tagging failed or running locally"
